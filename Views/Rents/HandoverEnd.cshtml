@model RentHandoverEndViewModel
<br />
<h3>Protokół zwrotu @Model.CarReg</h3>
<br />
<p>Firma: @Model.ClientName</p>
<p>Użytkownik: @Model.UserName</p>
<p>Telefon: @Model.UserPhone</p>
<br />
<table class="table-sm table-striped table-hover table-bordered">
    <thead>
        <tr>
            <td colspan="4" class="text-dark">Wydanie</td>
        </tr>
        <tr>
            <td colspan="2" class="text-center text-dark">Dane</td>
            <td colspan="2" class="text-center text-dark">Wyposażenie</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Data i godzina</td>
            <td>@Model.StartDate.ToString("dd-MM-yyyy hh:mm")</td>
            <td>Instrukcja</td>
            @if (@Model.StartManual)
            {
                <td><i class="fas fa-check"></i></td>
            }
            else
            {
                <td><i class="fas fa-times"></i></td>
            }
        </tr>
        <tr>
            <td>Przebieg</td>
            <td>@Model.StartMilage km</td>
            <td>Książka serwisowa</td>
            @if (@Model.StartService)
            {
                <td><i class="fas fa-check"></i></td>
            }
            else
            {
                <td><i class="fas fa-times"></i></td>
            }
        </tr>
        <tr>
            <td>Paliwo</td>
            <td>@Model.StartFuel %</td>
            <td>Trójkąt</td>
            @if (@Model.StartTriangle)
            {
                <td><i class="fas fa-check"></i></td>
            }
            else
            {
                <td><i class="fas fa-times"></i></td>
            }
        </tr>
        <tr>
            <td>Uwagi</td>
            <td>@Model.StartNotes</td>
            <td>Gaśnica</td>
            @if (@Model.StartFireEx)
            {
                <td><i class="fas fa-check"></i></td>
            }
            else
            {
                <td><i class="fas fa-times"></i></td>
            }
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td>Koło zapasowe/dojazdowe</td>
            @if (@Model.StartSpare)
            {
                <td><i class="fas fa-check"></i></td>
            }
            else
            {
                <td><i class="fas fa-times"></i></td>
            }
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td>Zestaw naprawczy</td>
            @if (@Model.StartRepairSet)
            {
                <td><i class="fas fa-check"></i></td>
            }
            else
            {
                <td><i class="fas fa-times"></i></td>
            }
        </tr>
    </tbody>
</table>
<br />
<form asp-action="HandoverEnd" asp-controller="Rents" method="post" enctype="multipart/form-data">
    <!--Dane do protokołu-->
    <div class="form-group row">
        <label asp-for="EndDate" class="col-sm-2 col-form-label"></label>
        <div class="col-sm-8">
            <input type="datetime" id="datetimeinput" value="@DateTime.Now" asp-for="EndDate" class="form-control" />
            <span asp-validation-for="EndDate" class="text-danger"></span>
        </div>
        <div class="col-sm-2">
            <button type="button" class="btn btn-success" id="timebutton">Teraz</button>
        </div>
    </div>
    <div class="form-group row">
        <label asp-for="EndMilage" class="col-sm-2 col-form-label"></label>
        <div class="col-sm-10">
            <input asp-for="EndMilage" class="form-control" max="100" min="0" />
            <span asp-validation-for="EndMilage" class="text-danger"></span>
        </div>
    </div>
    <div class="form-group row">
        <label asp-for="EndFuel" class="col-sm-2 col-form-label"></label>
        <div class="col-sm-10">
            <input asp-for="EndFuel" class="form-control" />
            <span asp-validation-for="EndFuel" class="text-danger"></span>
        </div>
    </div>
    <!--Checkboxy-->
    <div class="form-group row">
        <label asp-for="EndManual" class="col-sm-2 col-form-label"></label>
        <div class="col-sm-2">
            <input asp-for="EndManual" class="form-control" />
            <span asp-validation-for="EndManual" class="text-danger"></span>
        </div>
        <label asp-for="EndService" class="col-sm-2 col-form-label"></label>
        <div class="col-sm-2">
            <input asp-for="EndService" class="form-control" />
            <span asp-validation-for="EndService" class="text-danger"></span>
        </div>
        <label asp-for="EndTriangle" class="col-sm-2 col-form-label"></label>
        <div class="col-sm-2">
            <input asp-for="EndTriangle" class="form-control" />
            <span asp-validation-for="EndTriangle" class="text-danger"></span>
        </div>
    </div>
    <div class="form-group row">
        <label asp-for="EndFireEx" class="col-sm-2 col-form-label"></label>
        <div class="col-sm-2">
            <input asp-for="EndFireEx" class="form-control" />
            <span asp-validation-for="EndFireEx" class="text-danger"></span>
        </div>
        <label asp-for="EndSpare" class="col-sm-2 col-form-label"></label>
        <div class="col-sm-2">
            <input asp-for="EndSpare" class="form-control" />
            <span asp-validation-for="EndSpare" class="text-danger"></span>
        </div>
        <label asp-for="EndRepairSet" class="col-sm-2 col-form-label"></label>
        <div class="col-sm-2">
            <input asp-for="EndRepairSet" class="form-control" />
            <span asp-validation-for="EndRepairSet" class="text-danger"></span>
        </div>
    </div>
    <!--Koniec checkboxów-->
    <div class="form-group row">
        <label asp-for="EndNotes" class="col-sm-2 col-form-label"></label>
        <div class="col-sm-10">
            <input asp-for="EndNotes" class="form-control" />
            <span asp-validation-for="EndNotes" class="text-danger"></span>
        </div>
    </div>
    <h4>Uszkodzenia</h4>
    <canvas width="1140" height="728" id="img" style="background-image :url('/diagram.png'); position: relative"></canvas>
    @foreach (var item in @Model.CarDamages)
        {
            <script type="text/javascript">
                var canvas = document.getElementById("img");
                var btn = document.createElement("button");
                btn.style.position = "absolute";
                btn.style.height = '40px';
                btn.style.width = '40px';
                var xfinal = (@item.OffsetX + canvas.offsetLeft - 20);
                var yfinal = (@item.OffsetY + canvas.offsetTop - 20);
                btn.style.left = xfinal + 'px';
                btn.style.top = yfinal + 'px';
                btn.style.borderRadius = '20px';
                btn.style.backgroundColor = "green";
                btn.style.border = "0";
                btn.onclick = f1;
                btn.setAttribute("class", "read-modal");
                btn.setAttribute("data-targeturl","@Url.Action("PopulateModal","Rents",new { id = item.Id })")
                btn.id = ("@item.Id.ToString()");
                document.body.appendChild(btn);
            </script>
        }
    <button type="submit" class="btn btn-primary">Dodaj</button>
</form>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js"></script>
    <script>

    function f1() {
        const btnCl = this.classList[0];
        if (btnCl === 'form-modal') {
            $.get($(this).data("targeturl"), function (data) {
                $('<div id="modal-container" class="modal fade">'+data+'</div>').modal();
            });
        } else if (btnCl === 'read-modal') {
            $.get($(this).data("targeturl"), function (data) {
                $('<div id="modal-container-read" class="modal fade">'+data+'</div>').modal();
            });
        }
    };
    function inputDate() {
        var now = new Date();
        var day = ("0" + now.getDate()).slice(-2);
        var month = ("0" + (now.getMonth() + 1)).slice(-2);
        var today = now.getFullYear() + "-" + (month) + "-" + (day);
        $('input.datetime').val(today);
    }
    $(document).ready(function ()
    {
        $(function () {
            $('#timebutton').click(function () {
                alert("clicked");
                var time = new Date();
                $('#datetimeinput').val(time.toString());
            });
        });
        var guids = @Html.Raw(Json.Serialize(Model.Guids));
        var Idcounter = 48;
        var lastbtnId = "";

        $('body').on('hidden.bs.modal', "#modal-container", function () {
            $('#' + lastbtnId).attr("class", "read-modal");
            $('#' + lastbtnId).attr("data-targeturl","PopulateModal?id=" + lastbtnId);
            $('#' + lastbtnId).data("targeturl", "PopulateModal?id=" + lastbtnId);
            $('#' + lastbtnId).css("background-color", "yellow");
            $('#' + lastbtnId).css("border", "0");
        });

        $('#img').click(function (e) {
            const btns = [...document.querySelectorAll("button.form-modal")]
                if (btns.length===0) {
                    var btn = document.createElement("button");
                    var div = document.getElementById("img");
                    btn.style.position = "absolute";
                    btn.style.height = '40px';
                    btn.style.width = '40px';
                    btn.type = "button";
                    var rect = div.getBoundingClientRect();
                    var x = (e.clientX - rect.left) / (rect.right - rect.left) * 1140;
                    var y = (e.clientY - rect.top) / (rect.bottom - rect.top) * 728;
                    var xfinal = (x + this.offsetLeft - 20);
                    var yfinal = (y + this.offsetTop - 20);
                    btn.style.left = xfinal + 'px';
                    btn.style.top = yfinal + 'px';
                    btn.style.borderRadius = '20px';
                    btn.style.backgroundColor = "red";
                    btn.style.border = "0";
                    btn.setAttribute("class", "form-modal");
                    btn.onclick = f1;
                    btn.id = guids[Idcounter];
                    Idcounter = Idcounter - 1;
                    lastbtnId = btn.id;
                    btn.setAttribute("data-targeturl", "formmodal?routevalues=" + xfinal + "," + yfinal + "," + btn.id + "," + @Model.CarId.ToString() + "," + "end" + "," + @Model.RentId.ToString());
                    document.body.appendChild(btn);
                }
        });
    });
    </script>
}